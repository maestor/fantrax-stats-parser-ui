<div
  class="stats-table-wrapper mat-elevation-z4"
  [attr.id]="tableId"
  tabindex="-1"
  #tableRoot
>
  <p class="sr-only" [attr.id]="instructionsId">
    {{ 'a11y.tableNavigationHint' | translate }}
  </p>

  <div class="search-container">
    <mat-form-field subscriptSizing="dynamic">
      <mat-label>{{ "table.playerSearch" | translate }}</mat-label>
      <input
        matInput
        type="search"
        autocomplete="off"
        (input)="filterItems($event)"
        (keydown)="onSearchKeydown($event)"
        #searchInput
      />
    </mat-form-field>
  </div>

  <div class="table-container">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      matSortStart="desc"
      [attr.aria-describedby]="instructionsId"
    >
      <!-- Auto increment position column -->
      <ng-container matColumnDef="position">
        <th mat-header-cell *matHeaderCellDef>
          <span matTooltip="{{ 'tableColumn.position' | translate }}">
            {{ "tableColumnShort.position" | translate }}
          </span>
        </th>
        <td mat-cell *matCellDef="let element; let i = index">
          {{ i + 1 }}
        </td>
      </ng-container>

      <!-- Dynamic column renderer based on data -->
      @for (column of dynamicColumns; track column) {
      <ng-container [matColumnDef]="column">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <span matTooltip="{{ 'tableColumn.' + column | translate }}">
            {{ "tableColumnShort." + column | translate }}
          </span>
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element[column] !== "" ? element[column] : "-" }}
        </td>
      </ng-container>
      }

      <tr
        mat-header-row
        (keydown)="onHeaderKeydown($event)"
        *matHeaderRowDef="displayedColumns"
      ></tr>
      <tr
        mat-row
        #dataRow
        (click)="selectItem(row)"
        (focus)="onRowFocus(i)"
        (keydown)="onRowKeydown($event, row, i)"
        [attr.tabindex]="getRowTabIndex(i)"
        [attr.data-row-index]="i"
        [class.a11y-active]="i === activeRowIndex"
        [attr.aria-label]="getRowAriaLabel(row)"
        aria-haspopup="dialog"
        *matRowDef="let row; columns: displayedColumns; let i = index"
      ></tr>
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-results" [colSpan]="displayedColumns.length">
          <span>
              @if (apiError) {
                {{ "table.apiUnavailable" | translate }}
              } @else if (loading) {
              @if (showWarmupMessage) {
                {{ "table.loadingWarmup" | translate }}
              } @else {
                {{ "table.loading" | translate }}
              }
              } @else {
                {{ "table.noSearchResults" | translate }}
              }
          </span>

          @if (loading && !apiError) {
          <mat-progress-bar
            class="loading-bar"
            mode="buffer"
            [value]="loadingProgress"
            [bufferValue]="loadingBuffer"
          ></mat-progress-bar>
          }
        </td>
      </tr>
    </table>
  </div>
</div>
